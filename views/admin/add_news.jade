extends ../layout2.jade
block head
    script(src='/static/lib/ckeditor/ckeditor.js')
    link(rel='stylesheet', href='/static/less/user-profile.css')
block content
    section#account.account-page.section-padding
        .container
            ol.breadcrumb
                li
                    a.breadcrumb(href='/tai-khoan?tab=quan-ly-tin-tuc') Tin
                li.active
                    a.breadcrumb(href='#') ThÃªm Tin
            .row
                .col-sm-12
                    .single-input.p-bottom50.clearfix
                        form(action='/add_news', method='post')
                            .err
                                | #{errorMessage}
                            .form-group
                                .row
                                    .col-lg-1
                                        label Title
                                    .col-lg-9
                                        input.form-control#header(type='text', name='header', required, value=news.header)
                                    .col-lg-2
                                        span#counter (0)
                            .form-group
                                .row
                                    .col-lg-1
                                        label Category:
                                    .col-lg-9
                                        select#categories.form-control(name='category')
                            .form-group
                                .row
                                    .col-lg-1
                                        label URL:
                                    .col-lg-9
                                        .row
                                            .col-lg-5
                                                .input-group
                                                    span.input-group-addon https://tera.vn/tin-tuc/
                                                    input#url.form-control(type='text', name='url', required='', readonly)
                                            .col-lg-7
                                                button#custom_url.left.form-control.btn.btn-link(type='button', name='url', required, value=news.url readonly)  Use Custom URL instead
                            .form-group
                                .row
                                    .col-lg-1
                                        label.cursor-pointer(for='avatar') Thumbnail:
                                    .col-lg-9
                                        label.cursor-pointer(for='avatar')
                                             #avatar-place-holder.square-80.media-upload(style='background-image: url("/static/img/upload.svg")')
                                        input#avatar.input-file.hidden(type='file')
                                        input#ava.hidden(type='text', name='picture')

                            .form-group
                                .row
                                    .col-lg-1
                                        label.cursor-pointer(for='avatar') Thumbnail:
                                    .col-lg-9
                                        textarea.form-control#content(type='text', name='content', required, value=news.content)
                            .form-group
                                .col-lg-offset-5.col-lg-1
                                    button.btn.btn-danger.form-control#submitButton(type='submit') Create

    block script
        style.
            .breadcrumb {
                transition: all 0.3s ease 0s;
                text-decoration: none;
                font-weight: 400;
                color: #000000;
                text-transform: none;
                font-family: 'Montserrat', sans-serif;
            }
            #account {
                margin-top: 100px;
                margin-bottom: 50px;
            }
        script.

            $.post('/get_categories', function ( data, err) {
                $('#categories').html('');
                $.each(data.categories, function (index, category) {
                    $('#categories').append($('<option>', {
                        value: category.code,
                        url: category.url,
                        text: category.name
                    }));
                });
            })

            var suggestionUrl ='';

            $('#header, #categories').change(function () {
                $.post('/generate_news_url', {name: $('#header').val(), category: $('#categories option:selected').attr('url')}, function (data, error) {
                    $('#url').val(data.url);
                    suggestionUrl = data.url;
                });
            })

            $('#custom_url').click(function () {
                if ($(this).text().indexOf('Custom') > -1) {
                    $('#url').prop('readonly', false);
                    $(this).text('Use Suggested URL');
                } else {
                    $('#url').prop('readonly', true);
                    $(this).text('Use Custom URL');
                    $('#url').val(suggestionUrl);
                }
            })

            $('#header').keyup(function () {
                var counterTempate = '(%d)';
                var counter = $('#header').val().length;
                $('#counter').text(counterTempate.replace("%d" , counter) );
            })

            CKEDITOR.replace('content', {
                extraPlugins: 'image2,imageuploader,wordcount'
            });

            var news = !{JSON.stringify(news || {})}
            //var myDropzone = new Dropzone("div#file", { url: "/file/post"});
            var avatar = '';
            $('#avatar').change(function () {
                var files = document.getElementById('avatar').files;
                if (files.length > 0) {
                    getBase64(files[0]);
                }
            });

            function getBase64(file) {
                var reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function () {
                    avatar = reader.result;
                    $('#avatar-place-holder').css("background-image", "url(" + avatar + ")");
                    $('#ava').val(avatar);
                };
                reader.onerror = function (error) {
                    console.log('Error: ', error);
                };
            }