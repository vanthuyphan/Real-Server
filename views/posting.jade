block head
    link(href='/static/lib/bootstrap-fileinput/css/fileinput.css', media='all', rel='stylesheet', type='text/css')
    link(href='/static/lib/bootstrap-fileinput/themes/explorer/theme.css', media='all', rel='stylesheet', type='text/css')
    script(src='/static/lib/bootstrap-fileinput/js/plugins/sortable.js', type='text/javascript')
    script(src='/static/lib/bootstrap-fileinput/js/fileinput.js', type='text/javascript')
    script(src='/static/lib/bootstrap-fileinput/js/locales/vi.js', type='text/javascript')
    script(src='/static/lib/bootstrap-fileinput/themes/explorer/theme.js', type='text/javascript')
    script(src='/static/lib/location/location-picker.min.js')
    script(src="/static/lib/jquery.validation.min.js")
    link(rel="stylesheet" href="/static/less/jquery-validation.css")
    script(src="/static/lib/bootstrap-notify.min.js")
    meta(name="description" content="Đăng Tin")
    title Đăng Tin
    script(type='application/ld+json').
        {
        "@context": "http://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
        "@id": "https://www.tera.vn/",
        "name": "Tera",
        }
        },{
        "@type": "ListItem",
        "position": 2,
        "item": {
        "@id": "https://www.tera.vn/dang-tin",
        "name": "Đăng tin",
        }
        }]
        }

extends ./layout2.jade

block content
    .tera-body.container
        .row
            ol.breadcrumb
                li
                    a.breadcrumb(href='/') Tera
                li
                    a.breadcrumb(href='/dang-tin') Đăng Tin
            .col-xs-12
                .panel.panel-tera-posting
                    .panel-heading.no-padding
                        span.text-left.title Đăng tin
                    .panel-body
                        form#posting-form.form-horizontal
                            .col-xs-12.col-sm-12.col-md-6
                                .row
                                    fieldset
                                        .col-md-12
                                            .row
                                                .form-group
                                                    label.col-md-4.control-label Loại giao dịch
                                                    .col-md-8
                                                        label.radio-inline(for='sell')
                                                            input#sell(type='radio', name='model', value='Buy', checked)
                                                            |                                                     Bán
                                                        label.radio-inline(for='rent')
                                                            input#rent(type='radio', name='model', value='For rent')
                                                            |                                                     Cho Thuê
                                        .col-md-12
                                            .row
                                                .form-group.required
                                                    label.col-md-4.control-label.text-left(for='type') Loại bất động sản
                                                    .col-md-4
                                                        select#type.form-control(value=post.typ)
                                                            option(value = '0' selected) Chọn loại BĐS
                                                            option(value='1') Chung Cư
                                                            option(value='3') Nhà Phố
                                                            option(value='4') Đất
                                        .col-md-12
                                            .row
                                                .form-group.required
                                                    label.col-md-4.control-label(for='address') Địa chỉ
                                                    .col-md-8
                                                        input#address.form-control(onFocus="geolocate()" name='add', placeholder='68 Tản Đà', required=true, value=post.add)
                                                        input#lat.form-control.sr-only(name='lat')
                                                        input#lon.form-control.sr-only(name='lon')

                                        .col-md-12
                                            .row
                                                .form-group
                                                    label.col-md-4.control-label(for='') Đăng hình
                                                    .col-md-12
                                                        input#files-input.file-loading(name='files-input', type='file', multiple='')
                                        .col-md-6
                                            .row
                                                .form-group
                                                    label.col-md-5.control-label(for='pri') Giá
                                                    .col-xs-12.col-md-7
                                                        .input-group
                                                            input#pri.form-control(name='pri', placeholder=10, type='number', value=post.pri)
                                                            .input-group-btn
                                                                a.btn.btn-default.dropdown-toggle(type='button', data-toggle='dropdown')
                                                                    span#unit
                                                                        | triệu
                                                                    span.glyphicon.glyphicon-chevron-down
                                                                ul.dropdown-menu.pull-right
                                                                    li
                                                                        a#mil(onclick='changePriceLabel(event)') triệu
                                                                    li
                                                                        a#milspuare(onclick='changePriceLabel(event)') triệu/m2
                                                                    li
                                                                        a#bil(onclick='changePriceLabel(event)') tỷ
                                                                    li
                                                                        a#milmonth(onclick='changePriceLabel(event)') triệu/th
                                                                    li
                                                                        a#milspuaremonth(onclick='changePriceLabel(event)') triệu/m2/th
                                        .col-md-6#nob_section
                                            .row
                                                .form-group
                                                    label.col-md-5.control-label(for='nob') Phòng ngủ
                                                    .col-xs-12.col-md-7
                                                        input#nob.form-control.input-md(type='number', placeholder=1, value=post.nob)
                                        .col-md-6
                                            .row
                                                .form-group
                                                    label.col-md-5.control-label(for='are') Diện tích
                                                    .col-xs-12.col-md-7
                                                        .input-group
                                                            input#are.form-control(type='number', placeholder=100, required=true, value=post.are)
                                                            .input-group-addon
                                                                | m
                                                                sup 2
                                        .col-md-6#now_section
                                            .row
                                                .form-group
                                                    label.col-md-5.control-label(for='now') Phòng Tắm
                                                    .col-xs-12.col-md-7
                                                        input#now.form-control.input-md(type='now', placeholder=1, value=post.now)

                                        .col-md-6
                                            .row
                                                .form-group
                                                    label.col-md-5.control-label(for='dir') Hướng
                                                    .col-xs-12.col-md-7
                                                        select#dir.form-control(name='dir', value=post.dir)
                                                            option(value='0') Không biết
                                                            option(value='1') Bắc
                                                            option(value='2') Đông bắc
                                                            option(value='3') Đông
                                                            option(value='4') Đông nam
                                                            option(value='5') Nam
                                                            option(value='6') Tây nam
                                                            option(value='7') Tây
                                                            option(value='8') Tây bắc
                                        .col-md-6
                                            .row
                                                .form-group
                                                    label.col-md-5.control-label(for='') Đường trước nhà
                                                    .col-xs-12.col-md-7
                                                        .input-group
                                                            input.form-control(type='number', placeholder=50)
                                                            .input-group-addon
                                                                | m
                                                                sup 2

                                        .col-md-6#nof_section
                                            .row
                                                .form-group
                                                    label.col-md-5.control-label(for='nof') Tầng
                                                    .col-xs-12.col-md-7
                                                        input#nof.form-control(type='number', placeholder=0, value=post.nof)
                                        .col-md-6
                                            .row
                                                .form-group
                                                    label.col-md-5.control-label(for='leg') Tình trạng pháp lý
                                                    .col-xs-12.col-md-7
                                                        select#leg.form-control(name='leg', value=post.leg)
                                                            option(value='0') Không xác định
                                                            option(value='1') Sổ hồng
                                                            option(value='2') Giấy đỏ
                                                            option(value='3') Giấy tay
                                                            option(value='4') Đang hợp thức hóa
                                                            option(value='5') Giấy tờ hợp lệ
                                                            option(value='6') Chủ quyền tư nhân
                                                            option(value='7') Hợp đồng
                            .col-xs-12.col-md-6
                                .row
                                    fieldset
                                        .form-group.required
                                            label.col-md-4.control-label(for='tit') Tiêu đề
                                            .col-md-8
                                                input#tit.form-control.input-md(name='tit', type='text', placeholder='Vd: bán nhà chính chủ giá rẻ, sổ hồng riêng Hóc Môn', value=post.tit || '')
                                        .form-group
                                            label.col-md-4.control-label(for='des') Mô tả
                                            .col-md-8
                                                textarea#des.form-control(name='des', rows='3', placeholder="Nhập nội dung") #{post.des}
                                        .col-xs-12.col-md-11.col-md-offset-1
                                            .row
                                                .panel.panel-tera-posting-2
                                                    .panel-heading.no-padding
                                                        span.text-left.title Tiện ích
                                                    .panel-body
                                                        #fea
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='1')
                                                                    span Máy lạnh
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='2')
                                                                    span Máy sưởi
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='3')
                                                                    span Ti vi
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='4')
                                                                    span Mạng
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='5')
                                                                    span Bồn tắm
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='6')
                                                                    span Máy nóng lạnh

                                        .col-xs-12.col-md-11.col-md-offset-1
                                            .row
                                                .panel.panel-tera-posting-2
                                                    .panel-heading.no-padding
                                                        span.text-left.title Môi trường xung quanh
                                                    .panel-body
                                                        #fac
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='1')
                                                                    span Hồ bơi
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='2')
                                                                    span Trường học
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='3')
                                                                    span Gần bờ sông
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='4')
                                                                    span Bệnh viện
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='5')
                                                                    span Đường lớn
                                                            .col-xs-12.col-sm-12.col-md-4.checkbox
                                                                label
                                                                    input(type='checkbox', name='6')
                                                                    span Siêu thị
                                        .form-group.text-right
                                            button#update-button(onclick='addPost()', type='button').btn.btn-danger Đăng tin
                                        .form-group.text-right
                                            button#close(onclick='closeWindow()', type='button').btn.btn-link Hủy

block page-script
    style.
        .tera-body.container {
            margin-top: 70px;
        }

        #map {
            min-height: 200px;
        }
    script.
        var address = {};
        var post = !{JSON.stringify(post || {})}
        if (post.lon) {
            $('#lon').val(post.lon)
        }
        if (post.lat) {
            $('#lat').val(post.lat)
        }
        $('#inputAddress').locationpicker();
        if (post.typ) $('#type').val(post.typ);
        if (post.mode == 1) {
            $('#sell').prop('checked', true);
        } else if (post.mode == 2){
            $('#rent').prop('checked', true);
        }
        if (post.dir) {
            $('#dir').val(post.dir);
        }
        if (post.leg) {
            $('#leg').val(post.leg);
        }
        if (post.fac) {
            populateArray(post.fac, '#fac')
        }
        if (post.fea) {
            populateArray(post.fea, '#fea')
        }
        if (post.lid) {
            $('#update-button').text('Cập nhật tin')
        }
        var unitText;
        var unit = post.unit;

        if (unit == 1) {
            unitText = 'triệu';
        } else if (unit == 2) {
            unitText = 'triệu/m2'
        } else if (unit == 3) {
            unitText = 'tỷ'
        }
        if (post.mode == 2) {
            unitText += '/th';
        }
        unitModeListener($('input:radio[name="model"]'));
        $('#unit').text(unitText);
        toggleFieldsOnTypeChanged(post.typ);

        $('#milmonth').hide();
        $('#milspuaremonth').hide();

        $('#type').on('change', function () {
            var type = ($('#type').val());
            toggleFieldsOnTypeChanged(type);
        });

        var previewImages = [];
        if (post.img) {
            for (var i = 0; i < post.img.length; i++) {
                previewImages.push(post.img[i])
            }
        }

        $("#files-input").fileinput({
            uploadUrl: '/file-upload-batch/2',
            maxFilePreviewSize: 10240,
            previewSettings: {
                image: {width: "100px", height: "115px"},
                object: {width: "100px", height: "115px"},
            },
            initialPreview: previewImages,
            language: 'vi',
            initialPreviewAsData: true,
            overwriteInitial: false,
            fileActionSettings: {
                showRemove: true,
                showUpload: false,
                showZoom: false,
                showDrag: false,
            }
        });

        function toggleFieldsOnTypeChanged(type) {
            if (type == 3) {
                $('#nof_section').show();
            } else {
                $('#nof_section').hide();
            }
            if (type == 4) {
                $('#nob_section').hide();
                $('#now_section').hide();
            } else {
                $('#nob_section').show();
                $('#now_section').show();
            }
        }

        function closeWindow() {
            window.location = 'tai-khoan?tab=lich-su-dang-tin';
        }

        function addPost() {
            $('#type').removeClass('error');
            $('#tit').removeClass('error');
            $('#address').removeClass('error');
            var $posting = $('#posting-form');
            $posting.validate();
            var tit = $('#tit').val();
            var pri = $('#pri').val() || 0;
            var are = $('#are').val() || 0;
            var des = $('#des').val();
            var dir = $('#dir').val();
            var nob = $('#nob').val() || 0;
            var now = $('#now').val() || 0;
            var nof = $('#nof').val() || 0;
            var mode = $('#sell').is(':checked') ? 1 : 2;
            var leg = $('#leg').val();
            var typ = $('#type').val();
            var fac = getCheckboxes('#fac');
            var fea = getCheckboxes('#fea');
            var unitText = $('#unit').text();
            var lon = $('#lon').val();
            var lat = $('#lat').val();
            var add = $('#address').val();
            var errorMessage = '';
            if (isEmpty(typ) || typ == 0) {
                $('#type').addClass('error');
                errorMessage = "Xin nhập loại bất động sản"
            }
            if (isEmpty(tit)) {
                $('#tit').addClass('error');
                errorMessage = "Xin nhập tiêu đề tin"
            }
            if (isEmpty(add)) {
                $('#address').addClass('error');
                errorMessage = "Xin nhập địa chỉ"
            }
            if (errorMessage != '') {
                $.notify({message: errorMessage}, {type: 'danger'});
                return;
            }
            var unit;
            if (unitText == 'triệu' || unitText == 'triệu/th') {
                unit = 1;
            } else if (unit == 'triệu/m2' || unit == 'triệu/m2/th') {
                unit = 2
            } else {
                unit = 3;
            }

            var data = {
                lid: post.lid,
                mode: mode, tit: tit,
                pri: pri, are: are, des: des,
                dir: dir, nob: nob, now: now,
                typ: typ, nof: nof, leg: leg,
                add: add,
                unit: unit, img: JSON.stringify(getImages())
            };
            if (lon && lat) {
                data.lon = lon;
                data.lat = lat;
            }
            data.fea = JSON.stringify(fea);
            data.fac = JSON.stringify(fac);
            $.post('/add_post', data, function (err, response) {
                $.notify({
                    // options
                    message: 'Tin đăng đang được lưu'
                }, {
                    // settings
                    type: 'danger'
                });
                closeWindow();
            })
        }

        function isEmpty(value){
          var isEmptyObject = function(a) {
            if (typeof a.length === 'undefined') { // it's an Object, not an Array
              var hasNonempty = Object.keys(a).some(function nonEmpty(element){
                return !isEmpty(a[element]);
              });
              return hasNonempty ? false : isEmptyObject(Object.keys(a));
            }

            return !a.some(function nonEmpty(element) { // check if array is really not empty as JS thinks
              return !isEmpty(element); // at least one element should be non-empty
            });
          };
          return (
            value == false
            || typeof value === 'undefined'
            || value == null
            || (typeof value === 'object' && isEmptyObject(value))
          );
        }

        function changePriceLabel(event) {
            var target = $(event.target);
            $('#unit').text(target.text());
        }

        function getCheckboxes(selector) {
            var selected = [];
            var selector = selector + " input:checked";
            $(selector).each(function () {
                selected.push($(this).attr('name'));
            });
            return selected;
        }

        function populateArray(values, selector) {
            var selector = selector + " input";
            $(selector).each(function () {
                if (contains(values, Number($(this).attr('name')))) {
                    $(this).prop('checked', true);
                }
            });
        }

        function contains(array, value) {
            for (var i = 0; i < array.length; i++) {
                if (array[i] == value) {
                    return true;
                }
            }
            return false;
        }

        function getImages() {
            var imgs = $.find("img.file-preview-image");
            var imgSrcs = [];
            for (var i = 0; i < imgs.length; i++) {
                imgSrcs.push(imgs[i].src);
            }
            return imgSrcs;
        }
        $('input:radio[name="model"]').change(function () {
            unitModeListener(this);
        });
        function unitModeListener(el) {
            var unit = $('#unit').text();
            if ($(el).val() == 'Buy') {
                $('#mil').show();
                $('#milspuare').show();
                $('#bil').show();
                $('#milmonth').hide();
                $('#milspuaremonth').hide();
                $('#unit').text($('#mil').text());
            } else {
                $('#mil').hide();
                $('#milspuare').hide();
                $('#bil').hide();
                $('#milmonth').show();
                $('#milspuaremonth').show();
                $('#unit').text($('#milmonth').text());
            }
        }
    script.
        var placeSearch, autocomplete;
        function initAutocomplete() {
            autocomplete = new google.maps.places.Autocomplete(
            (document.getElementById('address')),
            {types: ['geocode']});
            autocomplete.addListener('place_changed', fillInAddress);
        }
        function fillInAddress() {
            var place = autocomplete.getPlace();
            if (place.geometry.location) {
                $('#lat').val(place.geometry.location.lat());
                $('#lon').val(place.geometry.location.lng());
                console.log("Lon", place.geometry.location.lng())
                console.log("Lat", place.geometry.location.lat())
            }
        }
        function geolocate() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                var geolocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            var circle = new google.maps.Circle({
                center: geolocation,
                radius: position.coords.accuracy
            });
            autocomplete.setBounds(circle.getBounds());
        });
        }
        }
        function getReverseGeocodingData(lat, lng) {
            var latlng = new google.maps.LatLng(lat, lng);
            // This is making the Geocode request
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'latLng': latlng }, function (results, status) {
                // This is checking to see if the Geoeode Status is OK before proceeding
                if (status == google.maps.GeocoderStatus.OK) {
                    $('#address').val(results[0].formatted_address);
                }
            });
        }
    script(src='https://maps.googleapis.com/maps/api/js?key=AIzaSyCqGIiz0D-0To4fE5J3H7qrVNOUcBVSpng&libraries=places&callback=initAutocomplete', async='', defer='')
